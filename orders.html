<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Orders - Catering</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <nav>
      <a href="index.html">Home</a>
      <a id="nav-profile" href="profile.html">Profile</a>
      <a id="nav-admin" href="admin.html">Admin</a>
      <a id="nav-cart" href="cart.html">Cart</a>
      <a id="nav-login" href="login.html">Login</a>
      <a id="nav-signup" href="signup.html">Signup</a>
      <button id="nav-logout" style="display:none;" onclick="doSignOut()">Logout</button>
    </nav>
  </header>

  <main class="container">
    <div id="global-message"></div>
    <h1>Orders</h1>
    <div id="orders-list">Loading orders…</div>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onSnapshot, collection, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { currentUser, currentUserRole, showMessage, logAction } from "./app.js";
    import { doSignOut } from "./app.js";
    window.doSignOut = doSignOut;

    async function init() {
      // wait a bit for auth state to populate
      const ordersList = document.getElementById("orders-list");
      const checkAuth = () => new Promise(res => setTimeout(res, 300));
      await checkAuth();

      const user = auth.currentUser;
      if (!user) {
        ordersList.innerHTML = "<p>Please login to view orders.</p>";
        return;
      }
      // if admin: show all orders; else show only user's orders
      let q;
      if (currentUserRole === "admin") {
        q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
      } else {
        q = query(collection(db, "orders"), where("userId", "==", user.uid), orderBy("createdAt", "desc"));
      }
      onSnapshot(q, snap => {
        if (snap.empty) {
          ordersList.innerHTML = "<p>No orders to show.</p>";
          return;
        }
        const html = snap.docs.map(d => {
          const o = { id: d.id, ...d.data() };
          return `
            <div class="order">
              <div><strong>Order ID:</strong> ${o.id}</div>
              <div><strong>Total:</strong> ₹${o.total}</div>
              <div><strong>Status:</strong> ${o.status}</div>
              <div><strong>Items:</strong> ${o.items.map(it => `<div>${it.name} x${it.qty}</div>`).join('')}</div>
              <hr/>
            </div>
          `;
        }).join("");
        ordersList.innerHTML = html;
      }, err => {
        ordersList.innerHTML = "<p>Failed to load orders: "+err.message+"</p>";
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
